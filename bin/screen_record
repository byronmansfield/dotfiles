#!/bin/bash

# configs
NAME=screencast-$(date +%Y%m%d%H%M)
FPS=15
THREADS=3
AUDIO_DRIVER="pulse"
AUDIO_DEVICE="alsa_input.usb-C-Media_Electronics_Inc._USB_PnP_Sound_Device-00.analog-mono"
AUDIO_RATE=44100

# prompt user
echo "Click the window to capture and get ready!"

# screen grap
tmpfile=/tmp/screengrab.tmp.$$
trap 'touch $tmpfile; rm -f $tmpfile' 0

# geometry of screen
xwininfo > $tmpfile 2>/dev/null
left=$(grep 'Absolute upper-left X:' $tmpfile | awk '{print $4}');
top=$(grep 'Absolute upper-left Y:' $tmpfile | awk '{print $4}');
width=$(grep 'Width:' $tmpfile | awk '{print $2}');
height=$(grep 'Height:' $tmpfile | awk '{print $2}');
geom="-geometry ${width}x${height}+${left}+${top}"
echo "Geometry: ${geom}"

SIZE="${width}x${height}"
POS="${left},${top}"
echo "Position= ${POS}; Size=${SIZE}"

# start recording
sleep 2
ffmpeg -y -f ${AUDIO_DRIVER} -ac 1 -ar ${AUDIO_RATE} -i ${AUDIO_DEVICE} \
  -f x11grab -r ${FPS} -s ${SIZE} -i ${DISPLAY-0:0}+${POS} \
  -vcodec libx264 -preset ultrafast -crf 18 -pix_fmt yuv420p ${NAME}.mkv

#echo Merge audio+video and encode to webm for YouTube? && read

# ffmpeg -i $NAME-tmp.mp4 -i $NAME-tmp.wav -acodec libvorbis -ab 128k -ac 2 -vcodec libvpx -qscale 8 -me_method full -mbd rd -flags +gmc+qpel+mv4 -trellis 1 -threads $THREADS $NAME-final.mkv
